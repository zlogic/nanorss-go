{{ define "content" }}
<form id="configurationForm" accept-charset="utf-8" autocomplete="off">
  <div class="form-group row">
    <label for="editUsername" class="col-sm-2 col-form-label">Username</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="editUsername" placeholder="Username" required>
    </div>
  </div>
  <div class="form-group row">
    <label for="editPassword" class="col-sm-2 col-form-label">Password</label>
    <div class="col-sm-10">
      <input type="password" class="form-control" id="editPassword" placeholder="Password">
    </div>
  </div>
  <div class="form-group row">
    <label for="editOPML" class="col-sm-2 col-form-label">OPML</label>
    <div class="col-sm-10">
      <textarea name="opml" id="editOPML" class="form-control" rows="20" required></textarea>
    </div>
  </div>
  <div class="form-group row">
    <label for="editPageMonitor" class="col-sm-2 col-form-label">Page Monitor</label>
    <div class="col-sm-10">
      <textarea name="pagemonitor" id="editPageMonitor" class="form-control" rows="20" required></textarea>
    </div>
  </div>
  <div class="form-group row">
    <div class="col-sm-2"></div>
    <div class="col-sm-10">
      <button type="submit" class="btn btn-primary">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
        Save</button>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-10">
      <div id="saveSuccessful" class="alert alert-success" role="alert" hidden>Saved successfully</div>
      <div id="saveFailed" class="alert alert-danger" role="alert" hidden>Save failed</div>
    </div>
  </div>
</form>
<script>  
document.addEventListener("DOMContentLoaded", () => {
  var opml = document.querySelector('textarea[name="opml"]');
  var pagemonitor = document.querySelector('textarea[name="pagemonitor"]');
  var username = document.querySelector('input[id="editUsername"]');
  var password = document.querySelector('input[id="editPassword"]');
  var submit = document.querySelector('button[type="submit"]');
  var spinner = submit.querySelector('span[role="status"]');
  var lockConfiguration = function(processing){
    [opml, pagemonitor, username, password, submit, spinner].forEach(function(control){
      control.disabled = processing;
    });
    spinner.hidden = !processing;
  };
  var showResultAlert = function(alertDiv){
    alertDiv.hidden = false;
    alertDiv.classList.add("animate__animated");
    alertDiv.classList.add("animate__flipInX");
  };

  var updateFormValues = function(settings) {
    username.value = settings.Username;
    password.value = "";
    opml.value = settings.Opml;
    pagemonitor.value = settings.Pagemonitor;
  };

  // Load current field items
  var form = document.getElementById("configurationForm");
  var loadItems = function() {
    lockConfiguration(true);
    spinner.hidden = true;

    var showError = function() {
      var alertDiv = document.createElement("div");
      alertDiv.setAttribute("class", "alert alert-danger animate__animated animate__flipInX");
      alertDiv.setAttribute("role", "alert");
      alertDiv.textContent = "Failed to fetch current configuration.";
      while(form.firstChild) form.removeChild(form.firstChild);
      form.append(alertDiv);
    };

    var request = new XMLHttpRequest();
    request.open("GET", "api/configuration", true);
    request.onload = function() {
      if (this.status >= 200 && this.status < 400) {
        var settings = JSON.parse(this.response);
        lockConfiguration(false);
        updateFormValues(settings);
      } else {
        showError();
      }
    };
    request.onerror = showError;
    request.send();
  };
  loadItems();

  // Submit configuration handler
  form.addEventListener("submit", function(event){
    event.preventDefault();
    lockConfiguration(true);
    // Prepare request
    var saveSuccessful = form.querySelector("#saveSuccessful");
    var saveFailed = form.querySelector("#saveFailed");
    saveSuccessful.hidden = true;
    saveFailed.hidden = true;

    var postData = "Username=" + encodeURIComponent(username.value) + "&" +
      "Opml=" + encodeURIComponent(opml.value) + "&" +
      "Pagemonitor=" + encodeURIComponent(pagemonitor.value);
    if (password.value !== null && password.value !== undefined && password.value !== "") {
      postData += "&" + "Password=" + encodeURIComponent(password.value)
    }

    var showError = function(){
      showResultAlert(saveFailed);
      lockConfiguration(false);
    };
    // Send data
    var request = new XMLHttpRequest();
    request.open("POST", "api/configuration", true);
    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    request.onload = function() {
      if (this.status >= 200 && this.status < 400) {
        showResultAlert(saveSuccessful);
        updateFormValues(JSON.parse(this.response));
        lockConfiguration(false);
      } else {
        showError();
      }
    };
    request.onerror = showError;
    request.send(postData);
  });
});
</script>
{{ end }}