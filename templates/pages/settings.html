{{ define "content" }}
<form id="configurationForm" accept-charset="utf-8" autocomplete="off">
  <div class="form-group row">
    <label for="editUsername" class="col-sm-2 col-form-label">Username</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="editUsername" placeholder="Username" value="{{ .Username }}" required>
    </div>
  </div>
  <div class="form-group row">
    <label for="editPassword" class="col-sm-2 col-form-label">Password</label>
    <div class="col-sm-10">
      <input type="password" class="form-control" id="editPassword" placeholder="Password">
    </div>
  </div>
  <div class="form-group row">
    <label for="editOPML" class="col-sm-2 col-form-label">OPML</label>
    <div class="col-sm-10">
      <textarea name="opml" id="editOPML" class="form-control" rows="20" required>{{ .User.Opml | html }}</textarea>
    </div>
  </div>
  <div class="form-group row">
    <label for="editPageMonitor" class="col-sm-2 col-form-label">Page Monitor</label>
    <div class="col-sm-10">
      <textarea name="pagemonitor" id="editPageMonitor" class="form-control" rows="20" required>{{ .User.Pagemonitor | html }}</textarea>
    </div>
  </div>
  <div class="form-group row">
    <div class="col-sm-2"></div>
    <div class="col-sm-10">
      <button type="submit" class="btn btn-primary">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
        Save</button>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-10">
      <div id="saveSuccessful" class="alert alert-success" role="alert" hidden>Saved successfully</div>
      <div id="saveFailed" class="alert alert-danger" role="alert" hidden>Save failed</div>
    </div>
  </div>
</form>
<script>
$(document).ready(function() {
  var opml = $('textarea[name="opml"]');
  var pagemonitor = $('textarea[name="pagemonitor"]');
  var username = $('input[id="editUsername"]');
  var password = $('input[id="editPassword"]');
  var submit = $('button[type="submit"]');
  var spinner = $('button[type="submit"] span[role="status"]');
  var lockConfiguration = function(processing){
    [opml, pagemonitor, username, password, submit, spinner].forEach(function(control){
      control.attr("disabled", processing);
    });
    spinner.prop("hidden", !processing);
  }
  var showResultAlert = function(alertDiv){
    alertDiv.hide();
    alertDiv.prop("hidden", false);
    alertDiv.slideDown();
  }
  // Submit configuration handler
  $("#configurationForm").submit(function(event) {
    event.preventDefault();
    lockConfiguration(true);
    // Prepare request
    var $form = $(this);
    $form.find("#saveFailed").prop("hidden", true);
    $form.find("#saveSuccessful").prop("hidden", true);
    var postData = {username: username.val(), password: password.val(), opml: opml.val(), pagemonitor: pagemonitor.val()};
    if(postData.password === null || postData.password === undefined || postData.password === '')
      delete postData.password;
    // Send data
    $.post("api/configuration", postData)
    .done(function(data) {
      showResultAlert($form.find("#saveSuccessful"));
    })
    .fail(function() {
      showResultAlert($form.find("#saveFailed"));
    })
    .always(function() {
      lockConfiguration(false);
    });
  });
});
</script>
{{ end }}